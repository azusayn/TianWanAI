# 操作手册

> 本软件服务通过 Docker 进行部署，启动软件需要先下载并装载镜像
接着将装载的镜像启动，得到运行的容器

## 安装
1. 先下载所有的 .7z 镜像
2. 传输所有镜像到服务器 /home 下
3. 使用指令参考

```bash
# 确保 docker 服务正常运行
systemctl status docker
# 如果 docker 没有在运行，用如下指令启动
# systemctl start docker

# 批量解压 7z 文件，得到 .tar 文件
7za x <文件 1> <文件 2> <文件 N ...>

# 加载所有镜像
# 加载好之后可以用 docker images 检查
docker load -i <镜像文件 1.tar> <镜像文件 2.tar> ... <镜像文件 N.tar>

# 启动服务 （一共有三个服务）
# tianwan 1 (手势，老鼠，香烟，烟雾，摔倒，短袖，积水，安全帽， 火焰)
# 这里 device=0，1 代表使用第 1、2 张显卡
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8901:8080 --gpus='"device=0, 1"' azusaing/tianwan:alpha

# tianwan 2 （安全带）
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8916:8080 --gpus='"device=1"' azusaing/tianwan2:v7

# 摄像头管理平台
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8080:8080 -v /home/app/output:/app/output -e FRAME_RATE=1 azusaing/cam-stream:v20

# 或者用这个可以现场采集图片和标签
# docker run --restart=always -d -p 8080:8080 -e DEBUG=1 -e FRAME RATE=1 
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8080:8080 -v /home/app/output:/app/output -e DEBUG=1 -e FRAME_RATE=1 azusaing/cam-stream:v20
```

由于实际需要承载高负载的流量以及 GPU 计算，需要同时部署多台推理服务器保证系统工作。
将 8901 ~ 8914 端口都分配给 tianwan 1 服务，而 8915 ~ 8918 端口分配给 tianwan 2 服务。实际服务部署使用指令如下：

```bash
#推理服务8个模型
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8901:8080 --gpus='"device=0"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8902:8080 --gpus='"device=0"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8903:8080 --gpus='"device=0"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8904:8080 --gpus='"device=0"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8905:8080 --gpus='"device=1"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8906:8080 --gpus='"device=1"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8907:8080 --gpus='"device=1"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8908:8080 --gpus='"device=1"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8909:8080 --gpus='"device=2"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8910:8080 --gpus='"device=2"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8911:8080 --gpus='"device=2"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8912:8080 --gpus='"device=2"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8913:8080 --gpus='"device=3"' azusaing/tianwan:alpha
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8914:8080 --gpus='"device=3"' azusaing/tianwan:alpha

##推理服务2个模型
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8915:8080 --gpus='"device=0"' azusaing/tianwan2:v7
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8916:8080 --gpus='"device=1"' azusaing/tianwan2:v7
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8917:8080 --gpus='"device=2"' azusaing/tianwan2:v7
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8918:8080 --gpus='"device=3"' azusaing/tianwan2:v7
,
#摄像头服务
docker run --restart=always --ulimit nofile=65535:65535 -d -p 8080:8080 -v /home/app/output:/app/output -e FRAME_RATE=1 azusaing/cam-stream:v20
```

4. 打开浏览器访问摄像头平台 http://<摄像头平台服务器 IP>:8080，点击导入配置按钮选择配置文件 `tianwan_config_v2` 以关联相应摄像头 。

## 查看容器运行日志

## 其他指令
- 拷贝服务器保存的图像
```bash
# 拷贝现场数据用于模型调优 (需要先开启现场图片采集)
docker cp <摄像头平台容器 id>:/app/debug .

# 拷贝标注图像
docker cp <摄像头平台容器 id>:/app/output .
```
- 停止以及删除容器或镜像
```bash
# 删除镜像
docker rmi <镜像 ID 1> <镜像 ID 2> ... <镜像 ID N>

# 停止容器
docker stop <镜像 ID 1> <镜像 ID 2> ... <镜像 ID N>

# 删除容器
docker rm <容器 ID 1> <容器 ID 2> ... <容器 ID N>
```
